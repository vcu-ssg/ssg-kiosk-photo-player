<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Photo Kiosk</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background-color: black;
      overflow: hidden;
    }
    #slideshow {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: black;
    }
    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      background: black;
    }
    .slide img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transform-origin: center center;
    }
    .title {
      position: absolute;
      bottom: 1.5rem;
      left: 0; right: 0;
      text-align: center;
      color: white;
      font-size: 2rem;
      text-shadow: 0 0 10px black;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="slideshow"></div>

  <script>
    async function loadShow() {
      const res = await fetch("/api/slideshow");
      const data = await res.json();
      return data.slides || [];
    }

    function applyEffect(el, effect, duration) {
      const durMs = (duration || 5) * 1000;
      switch (effect) {
        case "kenburns-zoom-in":
          el.animate([{ transform: "scale(1.0)" }, { transform: "scale(1.15)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
        case "kenburns-zoom-out":
          el.animate([{ transform: "scale(1.15)" }, { transform: "scale(1.0)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
        case "kenburns-pan-left":
          el.animate([{ transform: "scale(1.1) translateX(5%)" },
                      { transform: "scale(1.1) translateX(-5%)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
        case "kenburns-pan-right":
          el.animate([{ transform: "scale(1.1) translateX(-5%)" },
                      { transform: "scale(1.1) translateX(5%)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
        case "slide-left":
          el.animate([{ transform: "translateX(100%)", opacity: 0 },
                      { transform: "translateX(0)", opacity: 1 }],
            { duration: 1000, fill: "forwards", easing: "ease-out" });
          break;
        case "slide-right":
          el.animate([{ transform: "translateX(-100%)", opacity: 0 },
                      { transform: "translateX(0)", opacity: 1 }],
            { duration: 1000, fill: "forwards", easing: "ease-out" });
          break;
        case "fade":
        case "none":
        default:
          break; // handled by CSS opacity
      }
    }

    async function start() {
      const slides = await loadShow();
      const box = document.getElementById("slideshow");

      if (!slides.length) {
        box.innerHTML = "<h1 style='color:white;'>No slides found</h1>";
        return;
      }

      let idx = 0;
      const slideA = document.createElement("div");
      const slideB = document.createElement("div");
      slideA.className = "slide";
      slideB.className = "slide";
      box.appendChild(slideA);
      box.appendChild(slideB);

      function renderSlide(target, slide) {
        // Clear old content
        target.innerHTML = "";
        target.style.background = "black";

        if (slide.url) {
          const img = document.createElement("img");
          img.src = slide.url;
          target.appendChild(img);
          if (slide.title) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }
          applyEffect(img, slide.effect, slide.duration);
        }
        // blank slide: no image, just black background
      }

      function showNext() {
        const s = slides[idx];
        const nextIdx = (idx + 1) % slides.length;
        const nextSlide = idx % 2 === 0 ? slideB : slideA;
        const currentSlide = idx % 2 === 0 ? slideA : slideB;

        const next = slides[nextIdx];
        renderSlide(nextSlide, next);

        nextSlide.style.opacity = 1;
        currentSlide.style.opacity = 0;

        idx = nextIdx;
        setTimeout(showNext, (next.duration || 5) * 1000);
      }

      // Show first slide
      renderSlide(slideA, slides[0]);
      slideA.style.opacity = 1;
      setTimeout(showNext, (slides[0].duration || 5) * 1000);
    }

    start();
  </script>
</body>
</html>
