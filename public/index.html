<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Photo Kiosk</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: black;
      overflow: hidden;
    }
    #slideshow {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      align-items: center; justify-content: center;
      opacity: 0; background: black;
      transition: opacity 0.7s ease-in-out;
      backface-visibility: hidden;
    }
    .slide img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      object-position: center center;
      display: block;
      margin: auto;
      transform-origin: center center;
      backface-visibility: hidden;
    }
    .title {
      position: absolute;
      bottom: 1.5rem;
      left: 0; right: 0;
      text-align: center;
      color: white;
      font-size: 2rem;
      text-shadow: 0 0 10px black;
    }
    .mux-grid {
      display: grid;
      width: 100%; height: 100%;
      gap: 2px;
      background: black;
    }
    .mux-cell {
      background: black;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div id="slideshow"></div>

  <script>
    async function loadShow() {
      const res = await fetch("/api/slideshow");
      const data = await res.json();
      return data.slides || [];
    }

    function applyEffect(el, effect, duration) {
      const durMs = (duration || 5) * 1000;
      switch (effect) {
        case "cut":
          el.style.transition = "opacity 120ms linear";
          break;
        case "fade":
          el.style.transition = `opacity 700ms ease-in-out`;
          break;
        case "kenburns-zoom-in":
          el.animate([{ transform: "scale(1.0)" }, { transform: "scale(1.15)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
        case "kenburns-zoom-out":
          el.animate([{ transform: "scale(1.15)" }, { transform: "scale(1.0)" }],
            { duration: durMs, fill: "forwards", easing: "ease-in-out" });
          break;
      }
    }

    async function start() {
      const slides = await loadShow();
      const box = document.getElementById("slideshow");
      if (!slides.length) {
        box.innerHTML = "<h1 style='color:white;'>No slides found</h1>";
        return;
      }

      let idx = 0;
      let paused = false;
      const slideA = document.createElement("div"),
            slideB = document.createElement("div");
      slideA.className = "slide";
      slideB.className = "slide";
      box.appendChild(slideA);
      box.appendChild(slideB);

      async function playFrames(img, frames, fps, repeat, duration, effect, onDone) {
        const loops = repeat === undefined ? 1 : repeat;
        const perFrameTime =
          effect === "cut" || effect === "fade"
            ? (duration || 1) * 1000
            : 1000 / (fps || 10);
        let frameIdx = 0, loopCount = 0;
        function showFrame() {
          if (paused) return setTimeout(showFrame, perFrameTime);
          img.src = frames[frameIdx];
          frameIdx++;
          if (frameIdx >= frames.length) {
            frameIdx = 0;
            loopCount++;
            if (loopCount >= loops) return onDone && onDone();
          }
          setTimeout(showFrame, perFrameTime);
        }
        showFrame();
      }

      function renderSlide(target, slide, allSlides, onDone) {
        target.innerHTML = "";
        target.style.transition = "";

        // --- MUX slide ---
        if (slide.type === "mux") {
          const grid = document.createElement("div");
          grid.className = "mux-grid";
          const [rows, cols] = slide.layout.split("x").map(Number);
          grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
          grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
          target.appendChild(grid);

          if (slide.title && !slide.hide_panel_titles) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }

          slide.panels.forEach((panel, i) => {
            const cell = document.createElement("div");
            cell.className = "mux-cell";
            grid.appendChild(cell);

            if (!panel.slides || !panel.slides.length) return;

            const deck = panel.slides.map(id => allSlides.find(s => s.id === id)).filter(Boolean);
            if (!deck.length) return;

            if (panel.panel_duration === "infinite") {
              const s = deck[0];
              renderSlide(cell, { ...s, suppressTitle: true, hide_panel_titles: true }, allSlides, () => {});
              return;
            }

            let panelIdx = 0;
            function showPanelSlide() {
              if (paused) return setTimeout(showPanelSlide, 500);
              const s = deck[panelIdx];
              renderSlide(cell, { ...s, suppressTitle: true, hide_panel_titles: true }, allSlides, () => {});
              panelIdx = (panelIdx + 1) % deck.length;
              const perSlideMs =
                panel.panel_duration === "infinite"
                  ? 5000
                  : (panel.panel_duration || 5) * 1000;
              setTimeout(showPanelSlide, perSlideMs);
            }
            const offset = (i * 1000) % 4000;
            setTimeout(showPanelSlide, offset);
          });

          if (onDone && slide.duration !== "infinite")
            setTimeout(onDone, (slide.duration || 30) * 1000);
          return;
        }

        // --- Multi-frame sequence ---
        if (slide.frames && slide.frames.length) {
          const img = document.createElement("img");
          img.src = slide.frames[0];
          target.appendChild(img);
          if (slide.title && !(slide.hide_panel_titles || slide.suppressTitle)) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }
          playFrames(img, slide.frames, slide.fps, slide.repeat, slide.duration, slide.effect, onDone);
          return;
        }

        // --- Still image ---
        if (slide.url && !slide.type) {
          const img = document.createElement("img");
          img.src = slide.url;
          target.appendChild(img);
          if (slide.title && !(slide.hide_panel_titles || slide.suppressTitle)) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }
          applyEffect(img, slide.effect, slide.duration);
          if (onDone) setTimeout(onDone, (slide.duration || 5) * 1000);
          return;
        }

        // --- HTML slide ---
        if (slide.type === "html" && slide.url) {
          const iframe = document.createElement("iframe");
          iframe.src = slide.url;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.opacity = "0";
          iframe.onload = () => (iframe.style.opacity = "1");
          iframe.allow = "fullscreen";
          target.appendChild(iframe);
          if (slide.title && !(slide.hide_panel_titles || slide.suppressTitle)) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }
          iframe.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 600, fill: "forwards" });
          if (onDone) setTimeout(onDone, (slide.duration || 10) * 1000);
          return;
        }

        // --- YouTube slide ---
        if (slide.type === "youtube" && slide.video_id) {
          const iframe = document.createElement("iframe");
          iframe.src = `https://www.youtube.com/embed/${slide.video_id}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0`;
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.style.opacity = "0";
          iframe.allow =
            "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
          iframe.allowFullscreen = true;
          target.appendChild(iframe);
          if (slide.title && !(slide.hide_panel_titles || slide.suppressTitle)) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = slide.title;
            target.appendChild(title);
          }
          iframe.onload = () =>
            iframe.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 600, fill: "forwards" });
          if (onDone) setTimeout(onDone, (slide.duration || 30) * 1000);
          return;
        }

        if (onDone) setTimeout(onDone, (slide.duration || 5) * 1000);
      }

      function showSlide(newIdx) {
        if (newIdx < 0) newIdx = slides.length - 1;
        if (newIdx >= slides.length) newIdx = 0;
        idx = newIdx;
        const next = slides[idx];
        const nextSlide = idx % 2 === 0 ? slideA : slideB;
        const currentSlide = idx % 2 === 0 ? slideB : slideA;
        renderSlide(nextSlide, next, slides, () => {
          if (!paused) showSlide(idx + 1);
        });
        nextSlide.style.visibility = "visible";
        nextSlide.style.opacity = "1";
        currentSlide.style.opacity = "0";
      }

      renderSlide(slideA, slides[0], slides, () => showSlide(1));
      slideA.style.opacity = 1;

      window.addEventListener("keydown", (e) => {
        switch (e.key) {
          case " ":
            e.preventDefault();
            paused = !paused;
            break;
          case "ArrowRight": showSlide(idx + 1); break;
          case "ArrowLeft":  showSlide(idx - 1); break;
          case "Home":       showSlide(0); break;
          case "End":        showSlide(slides.length - 1); break;
        }
      });
    }

    start();
  </script>
</body>
</html>
